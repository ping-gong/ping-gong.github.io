<script>
  const terminal = document.getElementById('terminal');
  const tabs = document.querySelectorAll('.tab');

  let typingSession = 0; // üî• controls cancellation

  const content = {
    about: [
      {type:'prompt', text:'PingGPT ‚Ä∫ who is Ping?'},
      {type:'thinking', text:'Thinking‚Ä¶'},
      {text:'Ping R. Gong is a PhD candidate in Accounting at Yale University.'},
      {text:'His research focuses on labor and technology issues in accounting.'},
      {text:'He will be on the 2025‚Äì2026 academic job market.'}
    ],
    cv: [
      {type:'prompt', text:'PingGPT ‚Ä∫ open cv'},
      {type:'thinking', text:'Fetching document‚Ä¶'},
      {
        html:'Curriculum Vitae ‚Üí <a href="https://drive.google.com/file/d/1beN9zTzvjvvluaU4ljviKfS5SUV3EDjV/view" target="_blank">Download PDF</a>'
      }
    ],
    contact: [
      {type:'prompt', text:'PingGPT ‚Ä∫ contact'},
      {type:'thinking', text:'Generating contact information‚Ä¶'},
      {
        html:'Email ‚Üí <a href="mailto:ping.gong@yale.edu">ping.gong@yale.edu</a>'
      }
    ]
  };

  function typeSequence(seq){
    const sessionId = ++typingSession; // üö® invalidate old sessions
    terminal.innerHTML = '';

    let i = 0;

    function next(){
      // ‚ùå stop immediately if tab changed
      if(sessionId !== typingSession) return;

      if(i >= seq.length){
        const cursor = document.createElement('span');
        cursor.className = 'cursor';
        terminal.appendChild(cursor);
        return;
      }

      const item = seq[i];
      const div = document.createElement('div');
      div.className = 'line';
      if(item.type) div.classList.add(item.type);
      terminal.appendChild(div);

      if(item.html){
        // show HTML instantly
        div.innerHTML = item.html;
        i++;
        setTimeout(next, 120);
      } else {
        const text = item.text || '';
        let j = 0;
        const speed = item.type === 'thinking' ? 12 : 7;

        function typeChar(){
          if(sessionId !== typingSession) return; // ‚ùå cancel safely

          if(j < text.length){
            div.textContent += text[j++];
            setTimeout(typeChar, speed);
          } else {
            i++;
            setTimeout(next, 100);
          }
        }

        typeChar();
      }
    }

    next();
  }

  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      tabs.forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      typeSequence(content[tab.dataset.tab]);
    });
  });

  // initial load
  typeSequence(content.about);
</script>
